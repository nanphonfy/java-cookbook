设计系统时的墨菲定律：①任何事都没表面看起来的简单；②所有事都会比你预计的时间长；③可能出错，总会出错；④担心发生，更可能发生。  
系统拆分的康威定律：①架构反映公司；②应按业务闭环进行系统、组织架构划分，闭环、高内聚、低耦合；③若沟通有问题，考虑系统和组织结构调整；④不要一开始把系统、服务拆分得非常细（维护成本高）。

若起初遇到的不是核心问题，别复杂化设计，但先行规划和设计是有必要的。

## 1. 高并发原则

### 1.1 无状态
online：应用无状态（较容易水平扩展），配置文件（不同机房需读取不同数据源）有状态。

### 1.2 拆分
访问量非常大，投入资源较充足，可考虑按功能拆分系统。
>**维度**
>>系统：功能业务拆分，eg.购物车、结算、订单系统等；  
功能：对一个系统再拆分，eg.优惠券系统（后台券创建系统、领券系统、用券系统等）；  
读写：商品系统拆分为写服务（量太大时分库分表）、读服务（配合缓存）。聚合读取（eg.商品详情页），可将分散在多处的数据聚合到一块存储（数据异构数据库系统）；  
AOP：eg.商品详情页可分为CDN（AOP系统）、页面渲染系统；  
模块：eg.基础模块分库分表、数据库连接池，代码结构三层架构划分。

### 1.3 服务化
进程内服务->单机远程服务->集群手动注册服务->自动注册和发现服务（随着调用方越来越多，eg.dubbo使用zookeeper）->服务的分组+隔离（有的系统访问量太大）、路由（动态切换到不同分组）->服务治理如限流、黑白名单（调用量增加）。

### 1.4 消息队列
服务解耦（一对多消费）、异步处理、流量削峰、缓冲，用来解耦一些不需同步调用的服务或订阅一些自己系统关心的。若订阅者太多，单个队列成为瓶颈，可对队列进行多镜像复制；对于生产消息失败，在不能容忍的业务场景，一定要做持久化数据时增加日志、报警等；对于消息重复接收，需在业务层防重处理。
- 大流量缓冲
>促销活动时系统流量会高于正常流量几倍几十倍，此时牺牲强一致性，保证最终一致性即可。
eg.扣减库存时，直接在redis扣减，然后记录扣减日志，通过worker同步到库存DB。  
eg.交易订单系统，结算服务->接单服务->订单redis（用户单个订单详情）&订单队列表（可水平扩展多表，队列缓冲表提升接单能力），然后同步worker把缓冲表同步到订单中心表。若用户支付了订单，则订单状态机变更，此时可能订单队列表还没同步到订单中心表，状态机要重试。
>>同步woker设计时，要考虑并发处理和重复处理问题(单机串行or集群)，还要考虑是否对订单队列添加字段：处理人、处理状态、最后处理时间（应对超时）、失败次数等。
- 数据校对
>消息异步场景下，可能会丢失消息。可通过worker定期扫描原始表，对业务数据校对和修正补偿，来保证数据一致性与完整性。

### 1.5 数据异构
- 数据异构
>订单分库分表一般按订单ID切分，查询某用户订单列表需聚合多个表数据，导致读性能很低。此时需对订单表异构一套用户订单表（按user_id分库分表）。需对历史订单数据进行归档处理。eg.库存价格用数据异构意义不大，可考虑异步加载或合并并发请求。
- 数据闭环
>eg.商品详情页数据来源太多，影响服务稳定性的因素就非常多。解决方案：异构存储，形成数据闭环，闭环和异构其实是一个概念，目的都是实现数据的自我控制。

①MQ接收数据变更（一般通过消息队列分发数据），取出多数据源数据；
②数据聚合：可选，把多数据源数据进行聚合，then原子化存储到eg.redis或持久化kv存储；
③前端展示时，任何依赖系统出问题了，还是能正常工作（更新会有积压）。

### 1.6 缓存银弹
- 浏览器端缓存
>设置请求过期时间，eg.Expires、Cache-control，适用于对实时性不太敏感的数据，eg.商品详情页框架、商家评分、评价、广告词等（价格、库存对实时性要求较高）。

- app客户端缓存
>大促为防瞬间流量冲击，会在大促前把app需要访问的素材提前下发到客户端缓存。首屏数据也可缓存，在网络异常时还是有托底数据展示，地图也会做离线缓存。

- CDN缓存
>让用户能在离最近节点取到数据，两种机制：①推送（内容变更后主动推送到CDN边缘节点）和拉取（先访问边缘节点，无内容时，回源到源服务器拿到内容并存储到节点）。注：url有随机数，每次都穿透CDN回源到源服务器相当于CDN无效。爬虫，可返回过期数据而不回源。

- 接入层缓存
- 应用层缓存
- 分布式缓存

### 1.7 并发化

目标数据 | 数据A|数据B|数据C|数据D|数据E
---|---|---|---|---|---
获取时间(ms) | 10|15|20|5|10

串行获取，需60ms。
若C依赖A、B，E依赖C，并发化获取，需30ms。  
A B D  
C  
E  

