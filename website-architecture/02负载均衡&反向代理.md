将域名->多IP，若某服务器重启或发生故障时，切换时间长（因为DNS有一定缓存时间）且没有对后端服务心跳检查和失败重试的机制。可考虑HaProxy和Nginx。
注：外网DNS应用来全局负载均衡，将用户分配到离最近服务器（站长之家的"DNS查询"），内网DNS可实现简单的轮询负载均衡。  

Nginx的吞吐量有一定限制，可在NDS和Nginx间引接入层，eg.LVS(软件负载均衡器)、F5（硬负载均衡器）。  
**流程：** 浏览器访问某域名->DNS解析IP->把IP解析到LVS/F5->转发给Nginx->转发给后端real server。
一般场景下，Nginx（接入层、反向代理|负载均衡服务器）可取代HaProxy。上游服务器（upstream server）指负载均衡到的真实处理业务的服务器（real server）。

## 1. upstream配置
```
http {
    upstream backend{ 
        server 192.168.40.21:8080 weight=1;
        server 192.168.40.21:8081 weight=2;
    }
    location / {
        proxy_pass http://backend
    }
}
```
>每3次请求，有1个转发给8080,2个给8081。当访问Nginx时，会将请求代理到backend配置的upstream server。


## 2. 负载均衡算法
>①round-robin：默认，基于权重的轮询；②ip_hash：根据客户ip将相同ip负载均衡到同一个upstream server;③hash key [consistent]：对某一个key哈希或一致性哈希；④least_conn：负载均衡到最少活跃连接的upstream server，若server数较少，转而使用默认。
>>哈希算法，add/delete服务器，很多key被重新负载均衡到不同服务器，可能出问题；一致性哈希算法，只有少数key被重新负载均衡到不同服务器，推荐。
```
upstream backend{ 
    hash $uri;
    server 192.168.40.21:8080 weight=1;
    ...
}
upstream backend{ 
    hash $consistent_key consistent;
    server 192.168.40.21:8080 weight=1;
    ...
}
location / {
    set $consistent_key $arg_cat;
	if($consistent_key = ''){
	    set $consistent_key $request_uri;
	}
}
```
location会优先考虑请求参数cat（类目），如果没有，再根据请求uri负载均衡。

## 4. 健康检查
>默认采用惰性策略，可集成nginx_upstream_check_module模块主动进行健康检查（支持TCP和HTTP心跳）。

- TCP心跳检查
```
upstream backend{ 
	server 192.168.40.21:8080 weight=1;
	server 192.168.40.21:8081 weight=2;
	check interval=3000 rise=1 fall=3 timeout=2000 type=tcp；
}
```
>每隔3s检测1次，检测成功1次则标识为存活，检测失败3次则标识为不存活，请求超时2s

- HTTP心跳检查
```
upstream backend{ 
	server 192.168.40.21:8080 weight=1;
	server 192.168.40.21:8081 weight=2;
	check interval=3000 rise=1 fall=3 timeout=2000 type=http；
	check_http_send "HEAD /status HTTP /1.0\r\n\r\n";
	check_http_expect_alive http_2xx http_3xx;
}
```
>两个额外配置check_http_send（检查时发的请求内容）check_http_expect_alive（upstream server返回匹配的状态码，则标识存活）。

## 5. 其他配置
- 域名上游服务器
```
upstream backend{ 
	server c0.3.cn;
	server c1.3.cn;
}
```
>当域名ip变更，社区版（解析配置文件阶段将域名解析成IP并记录到stream上,不能更新）&商业版（才能动态更新）。

- 备份上游服务器
```
upstream backend{ 
	server 192.168.40.21:8080 weight=1;
	server 192.168.40.21:8081 weight=2 backup;
}
```
>当所有主upstream server都不存活，会转发给8081端口的备upstream server。压测时，为保险起见配置。

- 不可用上游服务器
```
upstream backend{ 
	server 192.168.40.21:8080 weight=1;
	server 192.168.40.21:8081 weight=2 down;
}
```
>当测试或机器故障，down可暂时摘掉机器。
