## 5. 客户端常见异常
- 无法从连接池获取连接
>JedisPool的Jedis对象有限（默认8个）。若连接都被占用，在maxWaitMillis时间内仍无法获得，抛异常：

```
redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource from the pool
…
Caused by: java.util.NoSuchElementException: Timeout waiting for idle object at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:449)
```

>当设置了blockWhenExhausted=false，池中无资源时，不等待直接抛异常


```
redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource from the pool
…
Caused by: java.util.NoSuchElementException: Pool exhausted at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:464)
```

>造成没有资源的原因：  
客户端：①高并发下连接池设置过小(一般比默认值多一些即可，JedisPool、Jedis的处理效率很高)；②没有及时释放连接；③有慢查询(jedis归还速度较慢，造成池满)。  
服务端：由于一些原因造成客户端执行过程的阻塞。

- 客户端读写超时


```
redis.clients.jedis.exceptions.JedisConnectionException:
java.net.SocketTimeoutException: Read timed out
```

>原因：①读写超时间设置得过短；②命令本身较慢；③客户端与服务端网络不正常；④Redis自身发生阻塞。

- 客户端连接超时


```
redis.clients.jedis.exceptions.JedisConnectionException:
java.net.SocketTimeoutException: connect timed out
```

>①连接超时设置过短；②Redis阻塞造成tcp-backlog已满，新连接失败；③客户端与服务端网络不正常。

- 客户端缓冲区异常

```
redis.clients.jedis.exceptions.JedisConnectionException: Unexpected end of stre
```

>①客户端的输出缓冲区满；②长时间闲置连接被服务端主动断开；③同时被并发读写。

- Lua脚本执行超过lua-time-limit

```
redis.clients.jedis.exceptions.JedisDataException: BUSY Redis is busy running a script. You can only call SCRIPT KILL or SHUTDOWN NOSAVE.
```

- 正在加载持久化文件


```
redis.clients.jedis.exceptions.JedisDataException: LOADING Redis is loading the dataset in memory
```

- 使用的内存超过maxmemory配置


```
redis.clients.jedis.exceptions.JedisDataException: OOM command not allowed when used memory >'maxmemory'
```

>应调整maxmemory并找到造成内存增长的原因

- 客户端连接数过大
>客户端连接数超过了maxclients，新申请的连接抛如下异常

```
redis.clients.jedis.exceptions.JedisDataException: ERR max number of clients re
```

>此时无法执行Redis命令进行问题修复，解决方法：
客户端基本不会超maxclients，一般是使用不当造成。若为分布式，可下线占用了连接较多的节点，先把连接数降下来，让绝大多数节点正常运行。再找bug或调整maxclients。  
服务端在redis为sentinel和cluster模式时，可故障转移(客户端无法处理时)。